<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventário Hextech - Quiz Legends</title>
    <style>
        :root {
            --ouro: #c89b3c;
            --ouro-claro: #f0e6d2;
            --fundo: #010a13;
            --card-bg: rgba(9, 20, 40, 0.9);
            --azul-hex: #091428;
            --comum: #808080;
            --raro: #00cfbc;
            --epico: #a335ee;
        }

        body {
            background: radial-gradient(circle at center, #0a323c 0%, #010a13 100%);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .header-inv {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--ouro);
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        .header-inv h1 {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 3px;
            background: linear-gradient(to bottom, var(--ouro-claro), var(--ouro));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        .grid-inventario {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 25px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .item-card {
            background: var(--card-bg);
            border: 1px solid #1e2328;
            padding: 20px 15px;
            text-align: center;
            position: relative;
            transition: all 0.3s;
            clip-path: polygon(10% 0, 90% 0, 100% 10%, 100% 90%, 90% 100%, 10% 100%, 0 90%, 0 10%);
        }

        .item-card:hover { transform: translateY(-5px); border-color: var(--ouro); }

        .icon-container { width: 80px; height: 80px; margin: 0 auto 15px; position: relative; }
        .img-item { width: 100%; height: 100%; border-radius: 4px; object-fit: cover; border: 1px solid rgba(200, 155, 60, 0.3); }

        .item-nome { 
            font-weight: 900; 
            text-transform: uppercase; 
            font-size: 0.8rem; 
            margin-bottom: 10px; 
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tag-tipo {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            color: var(--ouro-claro);
            opacity: 0.7;
        }

        .btn-acao {
            background: linear-gradient(to bottom, #1e2328, #010a13);
            border: 1px solid var(--ouro);
            color: var(--ouro);
            padding: 8px;
            width: 100%;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            font-size: 0.7rem;
            clip-path: polygon(10% 0, 90% 0, 100% 50%, 90% 100%, 10% 100%, 0 50%);
            transition: 0.3s;
        }

        .btn-acao:hover { background: var(--ouro); color: black; }
        
        .item-card.equipado { border-color: var(--raro); box-shadow: 0 0 15px rgba(0, 207, 188, 0.2); }
        .btn-acao.equipado { background: var(--raro); color: black; border-color: var(--raro); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--azul-hex); border: 2px solid var(--ouro); padding: 30px; max-width: 350px; text-align: center; clip-path: polygon(10% 0, 90% 0, 100% 15%, 100% 85%, 90% 100%, 10% 100%, 0 85%, 0 15%); }
        .modal-nome { color: var(--ouro); font-weight: bold; text-transform: uppercase; margin-bottom: 10px; }
        .modal-msg { color: #f0e6d2; font-size: 0.9rem; margin-bottom: 25px; line-height: 1.4; }
        .btn-confirm { background: var(--ouro); border: 1px solid var(--ouro-claro); color: black; padding: 10px 20px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin: 5px; }
        .btn-cancel { background: transparent; border: 1px solid var(--ouro); color: var(--ouro); padding: 10px 20px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin: 5px; }

        .vazio { grid-column: 1/-1; text-align: center; padding: 100px; opacity: 0.5; font-style: italic; }
        .btn-voltar { text-decoration: none; color: var(--ouro); border: 1px solid var(--ouro); padding: 5px 15px; font-size: 0.8rem; text-transform: uppercase; transition: 0.3s; }
        .btn-voltar:hover { background: var(--ouro); color: black; }
    </style>
</head>
<body>

    <div class="header-inv">
        <h1>Meu Inventário</h1>
        <a href="resgate.html" class="btn-voltar">Voltar</a>
    </div>

    <div class="grid-inventario" id="grid-inv">
        <p class="vazio">Carregando seus espólios...</p>
    </div>

    <div class="modal-overlay" id="modal-confirm">
        <div class="modal-content">
            <div id="modal-title" class="modal-nome">ATIVAR ITEM?</div>
            <div id="modal-message" class="modal-msg"></div>
            <div class="modal-btns" id="container-btns-modal">
                <button class="btn-confirm" id="btn-sim">Sim, Confirmar</button>
                <button class="btn-cancel" onclick="fecharModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayRemove, getDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4dm0KoyJswhyCY7tgbF4D2nmuZl84X8E",
            authDomain: "quizlegends-f58fc.firebaseapp.com",
            projectId: "quizlegends-f58fc",
            storageBucket: "quizlegends-f58fc.firebasestorage.app",
            messagingSenderId: "1050463164018",
            appId: "1:1050463164018:web:91de002b8afc8e678f54eb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const DATA_BASE = {
            'aatrox_comum': { nome: "Aatrox", tipo: "icone", img: "https://raw.githubusercontent.com/QuizLegends/quizlegends.github.io/main/ícones/aatrox-comum.png" },
            'aatrox_raro': { nome: "Aatrox Caçador", tipo: "icone", img: "https://raw.githubusercontent.com/QuizLegends/quizlegends.github.io/main/ícones/aatrox-raro.png" },
            'aatrox_epico': { nome: "Aatrox Vitorioso", tipo: "icone", img: "https://raw.githubusercontent.com/QuizLegends/quizlegends.github.io/main/ícones/aatrox-epico.png" },
            'ahri_comum': { nome: "Ahri", tipo: "icone", img: "https://raw.githubusercontent.com/QuizLegends/quizlegends.github.io/main/ícones/ahri-comum.png" },
            'ahri_raro': { nome: "Ahri Raposa Flamejante", tipo: "icone", img: "https://raw.githubusercontent.com/QuizLegends/quizlegends.github.io/main/ícones/ahri-raro.png" },
            'ahri_epico': { nome: "Ahri K/DA", tipo: "icone", img: "https://raw.githubusercontent.com/QuizLegends/quizlegends.github.io/main/ícones/ahri-epico.png" },
            'anjo_guardiao': { nome: "Anjo Guardião", tipo: "consumivel", duracao: 7, img: "https://raw.githubusercontent.com/QuizLegends/quizlegends.github.io/main/itens/anjo.png" },
            'sentinela-epico': { nome: "Sentinela de Controle", tipo: "carga", unidades: 3, img: "https://raw.githubusercontent.com/QuizLegends/quizlegends.github.io/main/itens/sentinela-epico.png" },
            'coletora-comum': { nome: "A Coletora", tipo: "multiplicador", duracaoHoras: 2, img: "https://raw.githubusercontent.com/QuizLegends/quizlegends.github.io/main/itens/coletora-comum.png" }
        };

        let usuarioDados = {};

        onAuthStateChanged(auth, (user) => {
            if (user) {
                onSnapshot(doc(db, "usuarios", user.uid), (snap) => {
                    if (snap.exists()) {
                        usuarioDados = snap.data();
                        renderInventario();
                    }
                });
            } else {
                window.location.href = "index.html";
            }
        });

        function renderInventario() {
            const grid = document.getElementById('grid-inv');
            grid.innerHTML = "";

            const icones = usuarioDados.iconesAdquiridos || [];
            const mochila = usuarioDados.mochila || [];
            const iconeEquipado = usuarioDados.iconeAtual || "";

            if (icones.length === 0 && mochila.length === 0) {
                grid.innerHTML = '<p class="vazio">Você ainda não possui itens ou ícones.</p>';
                return;
            }

            mochila.forEach(id => {
                const item = DATA_BASE[id];
                if (!item) return;
                grid.innerHTML += criarCard(id, item, "ATIVAR", false);
            });

            icones.forEach(id => {
                const item = DATA_BASE[id];
                if (!item) return;
                const estaEquipado = (id === iconeEquipado);
                grid.innerHTML += criarCard(id, item, estaEquipado ? "EQUIPADO" : "EQUIPAR", estaEquipado);
            });
        }

        function criarCard(id, item, txtBotao, isEquipado) {
            let tagTexto = "Consumível";
            if (item.tipo === 'icone') tagTexto = "Ícone de Perfil";
            if (item.tipo === 'carga') tagTexto = "Utilizável";
            if (item.tipo === 'multiplicador') tagTexto = "Bônus de PDL";

            return `
                <div class="item-card ${isEquipado ? 'equipado' : ''}">
                    <div class="tag-tipo">${tagTexto}</div>
                    <div class="icon-container">
                        <img src="${item.img}" class="img-item">
                    </div>
                    <div class="item-nome">${item.nome}</div>
                    <button class="btn-acao ${isEquipado ? 'equipado' : ''}" 
                        onclick="acaoItem('${id}', '${item.tipo}')" ${isEquipado ? 'disabled' : ''}>
                        ${txtBotao}
                    </button>
                </div>
            `;
        }

        window.acaoItem = (id, tipo) => {
            const item = DATA_BASE[id];
            const modal = document.getElementById('modal-confirm');
            const msg = document.getElementById('modal-message');
            const titulo = document.getElementById('modal-title');
            
            // Resetar botões do modal para o padrão
            document.getElementById('container-btns-modal').innerHTML = `
                <button class="btn-confirm" id="btn-sim">Sim, Confirmar</button>
                <button class="btn-cancel" onclick="fecharModal()">Cancelar</button>
            `;
            const novoBtnSim = document.getElementById('btn-sim');

            if (tipo === 'icone') {
                titulo.innerText = "EQUIPAR ÍCONE";
                msg.innerText = `Deseja equipar "${item.nome}" como seu ícone de perfil?`;
                novoBtnSim.onclick = () => equiparIcone(id);
            } else if (tipo === 'carga') {
                titulo.innerText = "ATIVAR REVELAÇÃO";
                msg.innerText = `Deseja ativar "${item.nome}"? Isso adicionará ${item.unidades} cargas de revelação ao seu Quiz.`;
                novoBtnSim.onclick = () => ativarSentinela(id);
            } else if (tipo === 'multiplicador') {
                titulo.innerText = "ATIVAR MULTIPLICADOR";
                
                // VERIFICAÇÃO DE SOBREPOSIÇÃO USANDO O MODAL PADRÃO
                const agora = Date.now();
                if (usuarioDados.statusAtivo?.dobrador_pdl && agora < usuarioDados.statusAtivo.dobrador_pdl) {
                    titulo.innerText = "ATENÇÃO INVOCADOR";
                    msg.innerHTML = `<span style="color:var(--ouro)">Você já possui um multiplicador ativo!</span><br><br>Se ativar este agora, o tempo do anterior será substituído por este novo bônus de 2 horas. Deseja prosseguir?`;
                } else {
                    msg.innerText = `Deseja ativar "${item.nome}" agora? Isso dobrará seus ganhos de PDL por ${item.duracaoHoras} horas.`;
                }
                
                novoBtnSim.onclick = () => ativarMultiplicador(id);
            } else {
                titulo.innerText = "ATIVAR CONSUMÍVEL";
                msg.innerText = `Deseja ativar "${item.nome}" agora? Isso iniciará o tempo de ${item.duracao} dias (acumulativo).`;
                novoBtnSim.onclick = () => ativarConsumivel(id);
            }
            modal.style.display = 'flex';
        };

        window.fecharModal = () => { document.getElementById('modal-confirm').style.display = 'none'; };

        function mostrarModalSucesso(titulo, htmlConteudo) {
            const modal = document.getElementById('modal-confirm');
            document.getElementById('modal-title').innerText = titulo;
            document.getElementById('modal-message').innerHTML = htmlConteudo;
            const containerBtns = document.getElementById('container-btns-modal');
            containerBtns.innerHTML = `<button class="btn-confirm" onclick="fecharModal()">OK</button>`;
            modal.style.display = 'flex';
        }

        async function equiparIcone(id) {
            fecharModal();
            try {
                const userRef = doc(db, "usuarios", auth.currentUser.uid);
                await updateDoc(userRef, { iconeAtual: id });
            } catch (e) {
                console.error("Erro ao equipar:", e);
            }
        }

        async function ativarSentinela(id) {
            fecharModal();
            const item = DATA_BASE[id];
            const userRef = doc(db, "usuarios", auth.currentUser.uid);
            try {
                await updateDoc(userRef, {
                    mochila: arrayRemove(id),
                    "statusAtivo.sentinelas": increment(3)
                });
                const snap = await getDoc(userRef);
                const totalCargas = snap.data().statusAtivo?.sentinelas || 0;
                const msgSucesso = `
                    <div style="text-align:center;">
                        <img src="${item.img}" style="width:60px; margin-bottom:10px; filter: drop-shadow(0 0 10px var(--raro));">
                        <p style="color:var(--raro); font-weight:bold; text-transform:uppercase;">${item.nome} Ativada!</p>
                        <p>Você possui agora <strong>${totalCargas} cargas</strong> disponíveis no Quiz.</p>
                    </div>
                `;
                mostrarModalSucesso("SUCESSO", msgSucesso);
            } catch (e) {
                console.error("Erro ao ativar sentinela:", e);
                mostrarModalSucesso("ERRO", "Falha na ativação Hextech.");
            }
        }

        async function ativarMultiplicador(id) {
            fecharModal();
            const item = DATA_BASE[id];
            const userRef = doc(db, "usuarios", auth.currentUser.uid);
            const agora = Date.now();
            const duracaoMs = item.duracaoHoras * 60 * 60 * 1000;

            try {
                await updateDoc(userRef, {
                    mochila: arrayRemove(id),
                    "statusAtivo.dobrador_pdl": agora + duracaoMs
                });

                const msgSucesso = `
                    <div style="text-align:center;">
                        <img src="${item.img}" style="width:60px; margin-bottom:10px; filter: drop-shadow(0 0 10px var(--ouro));">
                        <p style="color:var(--ouro); font-weight:bold; text-transform:uppercase;">${item.nome} Ativada!</p>
                        <p>Seus ganhos de PDL estão <strong>DOBRADOS</strong> pelas próximas ${item.duracaoHoras} horas.</p>
                    </div>
                `;
                mostrarModalSucesso("BÔNUS ATIVADO", msgSucesso);
            } catch (e) {
                console.error("Erro ao ativar multiplicador:", e);
                mostrarModalSucesso("ERRO", "Não foi possível processar a ativação.");
            }
        }

        async function ativarConsumivel(id) {
            fecharModal();
            const item = DATA_BASE[id];
            const userRef = doc(db, "usuarios", auth.currentUser.uid);
            const agora = Date.now();
            const tempoMs = item.duracao * 24 * 60 * 60 * 1000; 

            try {
                const snap = await getDoc(userRef);
                const dados = snap.data();
                const tempoAtual = (dados.statusAtivo && dados.statusAtivo[id] > agora) 
                    ? dados.statusAtivo[id] 
                    : agora;

                const novaValidade = tempoAtual + tempoMs;

                await updateDoc(userRef, {
                    mochila: arrayRemove(id),
                    [`statusAtivo.${id}`]: novaValidade
                });
                
                const diasRestantes = Math.ceil((novaValidade - agora) / (1000 * 60 * 60 * 24));

                const msgSucesso = `
                    <div style="text-align:center;">
                        <img src="${item.img}" style="width:60px; margin-bottom:10px; filter: drop-shadow(0 0 10px var(--ouro));">
                        <p style="color:var(--ouro); font-weight:bold; text-transform:uppercase;">${item.nome} Ativado!</p>
                        <p>Você possui agora <strong>${diasRestantes} dias</strong> de proteção acumulada.</p>
                    </div>
                `;
                mostrarModalSucesso("SUCESSO", msgSucesso);
            } catch (e) {
                console.error("Erro ao ativar:", e);
                mostrarModalSucesso("ERRO", "Falha na comunicação Hextech.");
            }
        }
    </script>
</body>
</html>
