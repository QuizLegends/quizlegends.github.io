<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cofre Hextech - Quiz Legends</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --gold: #c89b3c;
            --blue: #0ac8b9;
            --dark-blue: #091428;
            --dark: #010a13;
        }

        body {
            background: radial-gradient(circle at center, var(--dark-blue) 0%, var(--dark) 100%);
            color: #f0e6d2;
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        .container-bau {
            text-align: center;
            background: rgba(1, 10, 19, 0.9);
            border: 2px solid var(--gold);
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 0 30px rgba(0, 200, 185, 0.2);
            max-width: 400px;
            width: 100%;
            position: relative;
        }

        .bau-display {
            width: 250px;
            height: 250px;
            margin: 0 auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Imagem do Baú */
        .bau-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 15px var(--blue));
            transition: filter 0.5s;
        }

        /* Estado quando já foi aberto (Preto e Branco) */
        .bau-aberto-hoje {
            filter: grayscale(1) brightness(0.3) !important;
        }

        .animar-tremer {
            animation: tremer 0.4s infinite;
        }

        @keyframes tremer {
            0% { transform: translate(0,0) rotate(0deg); }
            25% { transform: translate(2px, 2px) rotate(1deg); }
            50% { transform: translate(-2px, -2px) rotate(-1deg); }
            75% { transform: translate(2px, -2px) rotate(1deg); }
            100% { transform: translate(0,0) rotate(0deg); }
        }

        h1 { color: var(--gold); text-transform: uppercase; letter-spacing: 2px; font-size: 1.5rem; margin-top: 0; }
        .status-msg { margin: 20px 0; min-height: 30px; font-size: 1.1rem; color: var(--blue); font-weight: bold; text-transform: uppercase; }

        .btn-abrir {
            background: linear-gradient(to bottom, #c89b3c, #785a28);
            border: 1px solid var(--gold);
            color: white;
            padding: 15px 30px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            transition: 0.3s;
        }

        .btn-abrir:disabled { background: #333; border-color: #555; cursor: not-allowed; opacity: 0.6; }

        .btn-resgatar {
            background: linear-gradient(to bottom, #0ac8b9, #005a5a);
            border: 1px solid #fff;
            box-shadow: 0 0 20px var(--blue);
        }

        .btn-voltar {
            margin-top: 20px;
            display: inline-block;
            text-decoration: none;
            color: var(--gold);
            font-size: 0.8rem;
            text-transform: uppercase;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div class="container-bau">
        <h1>Cofre Hextech</h1>
        
        <div class="bau-display" id="bau-display">
            <img id="bau-media" src="" class="bau-img">
        </div>

        <p class="status-msg" id="mensagem">Conectando ao cofre...</p>
        
        <button id="btn-acao" class="btn-abrir" onclick="iniciarAbertura()" disabled>Abrir Baú</button>
        <br>
        <a href="resgate.html" class="btn-voltar">Voltar para Resgate</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyC4dm0KoyJswhyCY7tgbF4D2nmuZl84X8E", 
            authDomain: "quizlegends-f58fc.firebaseapp.com", 
            projectId: "quizlegends-f58fc", 
            storageBucket: "quizlegends-f58fc.firebasestorage.app", 
            messagingSenderId: "1050463164018", 
            appId: "1:1050463164018:web:91de002b8afc8e678f54eb" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const GIF_PATH = "https://raw.githubusercontent.com/QuizLegends/quizlegends.github.io/main/ícones/bau-hextec.gif";
        let usuarioAtual = null;
        const somMoedas = new Audio('https://www.soundjay.com/misc/sounds/coins-spilled-1.mp3');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                usuarioAtual = user;
                verificarStatus();
            } else {
                window.location.href = "index.html";
            }
        });

        async function verificarStatus() {
            const userRef = doc(db, "usuarios", usuarioAtual.uid);
            const userDoc = await getDoc(userRef);
            const dados = userDoc.data() || {};
            const hoje = new Date().toISOString().split('T')[0];
            
            const media = document.getElementById('bau-media');
            const btn = document.getElementById('btn-acao');

            if (dados.ultimoBau === hoje) {
                document.getElementById('mensagem').innerText = "BAÚ JÁ ABERTO HOJE!";
                media.src = GIF_PATH;
                media.classList.add('bau-aberto-hoje');
                btn.disabled = true;
            } else {
                document.getElementById('mensagem').innerText = "COFRE PRONTO PARA ABRIR";
                // Inicialmente, definimos o GIF mas vamos "pausar" visualmente se possível 
                // ou apenas carregar quando clicar para garantir o tempo zero.
                media.src = GIF_PATH;
                btn.disabled = false;
            }
        }

        window.iniciarAbertura = async function() {
            const btn = document.getElementById('btn-acao');
            const msg = document.getElementById('mensagem');
            const media = document.getElementById('bau-media');

            btn.disabled = true;
            msg.innerText = "ABRINDO COFRE...";

            // RESET DO GIF: Forçamos o navegador a recarregar o arquivo do zero
            media.src = ""; 
            media.src = GIF_PATH + "?t=" + Date.now();
            
            // Efeito de tremor inicial
            media.classList.add('animar-tremer');

            const recompensa = Math.floor(Math.random() * (5000 - 500 + 1)) + 500;
            const hoje = new Date().toISOString().split('T')[0];

            // SINCRONIA DE 4 SEGUNDOS (4000ms)
            setTimeout(async () => {
                try {
                    const userRef = doc(db, "usuarios", usuarioAtual.uid);
                    const userSnap = await getDoc(userRef);
                    const saldoAtual = Number(userSnap.data()?.saldo || 0);

                    await setDoc(userRef, {
                        saldo: saldoAtual + recompensa,
                        ultimoBau: hoje
                    }, { merge: true });

                    // Finaliza animações
                    media.classList.remove('animar-tremer');
                    media.style.filter = "drop-shadow(0 0 30px #c89b3c)"; // Brilho de Ouro

                    // EFEITOS NO TEMPO CERTO
                    dispararFogos();
                    somMoedas.play();

                    msg.innerHTML = `<span style="color: #ff0; font-size: 1.5rem;">+ ${recompensa.toLocaleString()} MOEDAS!</span>`;
                    
                    btn.innerText = "RESGATAR E VOLTAR";
                    btn.disabled = false;
                    btn.classList.add('btn-resgatar');
                    btn.onclick = () => window.location.reload();

                } catch (e) {
                    console.error(e);
                    msg.innerText = "ERRO AO PROCESSAR RECOMPENSA";
                }
            }, 4000); // Sincronizado com os 4 segundos do seu GIF
        };

        function dispararFogos() {
            const duracao = 4 * 1000;
            const fim = Date.now() + duracao;

            (function frame() {
                confetti({
                    particleCount: 15,
                    angle: 60,
                    spread: 80,
                    origin: { x: 0, y: 0.7 },
                    colors: ['#c89b3c', '#0ac8b9', '#ffffff']
                });
                confetti({
                    particleCount: 15,
                    angle: 120,
                    spread: 80,
                    origin: { x: 1, y: 0.7 },
                    colors: ['#c89b3c', '#0ac8b9', '#ffffff']
                });

                if (Date.now() < fim) {
                    requestAnimationFrame(frame);
                }
            }());
        }
    </script>
</body>
</html>
