<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cofre Hextech - Quiz Legends</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #c89b3c;
            --blue: #0ac8b9;
            --dark: #010a13;
        }

        body {
            background: radial-gradient(circle at center, #091428 0%, var(--dark) 100%);
            color: #f0e6d2;
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container-bau {
            text-align: center;
            background: rgba(1, 10, 19, 0.8);
            border: 2px solid var(--gold);
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 100%;
        }

        .bau-imagem {
            width: 150px;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px var(--blue));
            cursor: pointer;
            transition: transform 0.3s;
        }

        .bau-imagem:hover {
            transform: scale(1.1);
        }

        .bau-imagem.animar {
            animation: tremer 0.5s infinite;
        }

        @keyframes tremer {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }

        h1 { color: var(--gold); text-transform: uppercase; letter-spacing: 2px; font-size: 1.5rem; }
        
        .status-msg { margin: 15px 0; min-height: 20px; font-size: 0.9rem; color: var(--blue); }

        .btn-abrir {
            background: linear-gradient(to bottom, #c89b3c, #785a28);
            border: 1px solid var(--gold);
            color: white;
            padding: 12px 30px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
        }

        .btn-abrir:disabled {
            background: #333;
            border-color: #555;
            cursor: not-allowed;
        }

        .btn-voltar {
            margin-top: 20px;
            display: inline-block;
            text-decoration: none;
            color: var(--gold);
            font-size: 0.8rem;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div class="container-bau">
        <h1>Ba√∫ Di√°rio</h1>
        <div id="bau-container">
            <div id="bau-visual" style="font-size: 80px; margin: 20px 0;">üéÅ</div>
        </div>
        
        <p class="status-msg" id="mensagem">Carregando status do ba√∫...</p>
        
        <button id="btn-acao" class="btn-abrir" onclick="abrirBau()" disabled>Abrir Ba√∫</button>
        
        <br>
        <a href="resgate.html" class="btn-voltar">Voltar para Resgate</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyC4dm0KoyJswhyCY7tgbF4D2nmuZl84X8E", 
            authDomain: "quizlegends-f58fc.firebaseapp.com", 
            projectId: "quizlegends-f58fc", 
            storageBucket: "quizlegends-f58fc.firebasestorage.app", 
            messagingSenderId: "1050463164018", 
            appId: "1:1050463164018:web:91de002b8afc8e678f54eb" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let usuarioAtual = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                usuarioAtual = user;
                verificarStatusBau();
            } else {
                window.location.href = "index.html";
            }
        });

        async function verificarStatusBau() {
            const userRef = doc(db, "usuarios", usuarioAtual.uid);
            const userDoc = await getDoc(userRef);
            const dados = userDoc.data();
            
            const agora = new Date();
            const hojeStr = agora.toISOString().split('T')[0]; // Pega apenas YYYY-MM-DD

            if (dados.ultimoBau === hojeStr) {
                document.getElementById('mensagem').innerText = "Voc√™ j√° abriu o ba√∫ de hoje! Volte amanh√£.";
                document.getElementById('btn-acao').disabled = true;
                document.getElementById('bau-visual').innerText = "üì¶"; // Ba√∫ aberto
            } else {
                document.getElementById('mensagem').innerText = "O ba√∫ est√° pronto para ser aberto!";
                document.getElementById('btn-acao').disabled = false;
            }
        }

        window.abrirBau = async function() {
            const btn = document.getElementById('btn-acao');
            const msg = document.getElementById('mensagem');
            const visual = document.getElementById('bau-visual');
            
            btn.disabled = true;
            msg.innerText = "Sorteando recompensa...";
            visual.classList.add('animar');

            // Simula anima√ß√£o de 2 segundos
            setTimeout(async () => {
                // Sorteio: 500 a 5000 moedas
                const recompensa = Math.floor(Math.random() * (5000 - 500 + 1)) + 500;
                
                const agora = new Date();
                const hojeStr = agora.toISOString().split('T')[0];

                try {
                    const userRef = doc(db, "usuarios", usuarioAtual.uid);
                    await updateDoc(userRef, {
                        pdlSemanal: increment(recompensa), // Adiciona as moedas
                        ultimoBau: hojeStr // Salva a data de hoje
                    });

                    visual.classList.remove('animar');
                    visual.innerText = "üí∞";
                    msg.innerHTML = `<span style="color: #ff0; font-size: 1.2rem;">+ ${recompensa} PDL Adicionados!</span>`;
                    
                } catch (error) {
                    console.error("Erro ao resgatar:", error);
                    msg.innerText = "Erro ao conectar ao servidor.";
                }
            }, 2000);
        }
    </script>
</body>
</html>
